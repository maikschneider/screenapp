<h1><i class="fa fa-play-circle"></i> Add new PlaylistItem</h1>
<hr />

<form action="/playlistitem<% if(item){ %>/<%= item %><% } %>" method="POST" data-action-url="/playlistitem/">

  <div data-abide-error role="alert" class="alert callout" style="display: none;" data-closable>
    <p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> There are some errors in your form</p>
    <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div data-abide-error role="alert" class="success callout" style="display: none;" data-closable>
    <p><i class="fa fa-check-circle" aria-hidden="true"></i> Successfully saved! </p>
    <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="row">
    <div class="medium-3 small-12 columns">
      <label for="name" class="text-left medium-text-right middle">Name</label>
    </div>
    <div class="medium-9 small-12 columns">
      <input type="text" id="name" name="name" placeholder="Item name" required aria-describedby="name-error" />
      <span class="form-error" id="name-error"></span>
    </div>
  </div>
  <div class="row">
    <div class="medium-3 small-12 columns">
      <label for="duration" class="text-left medium-text-right middle">Duration in seconds</label>
    </div>
    <div class="medium-9 small-12 columns">
      <input type="text" id="duration" name="duration" placeholder="30" aria-describedby="duration-error" />
      <span class="form-error" id="duration-error"></span>
    </div>
  </div>

  <div class="row">
    <div class="medium-3 small-12 columns">
      <label for="service" class="text-left medium-text-right middle color-item"><i class="fa fa-play-circle" aria-hidden="true"></i> App</label>
    </div>
    <div class="medium-9 small-12 columns">

      <ul class="tabs" data-tabs id="playlistitem-tabs">
        <li data-apptype="twitter" class="tabs-title is-active"><a href="#panel1" class="bg-twitter" aria-selected="true"><i class="fa fa-twitter"></i> Twitter</a></li>
        <li data-apptype="weather" class="tabs-title"><a href="#panel2" class="bg-weather"><i class="fa fa-sun-o"></i> Weather</a></li>
        <li data-apptype="msg" class="tabs-title"><a href="#panel3" class="bg-msg"><i class="fa fa-comment"></i> Message</a></li>
        <li data-apptype="dvb" class="tabs-title"><a href="#panel4" class="bg-dvb"><i class="fa fa-bus"></i> DVB Stop</a></li>
      </ul>

      <div class="tabs-content" data-tabs-content="playlistitem-tabs">
        <div class="tabs-panel is-active bg-twitter" id="panel1" data-apptype="twitter">
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Twitter Filter</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input type="text" id="twitterFilter" name="twitterFilter" placeholder="#music" aria-describedby="twitterFilter-error" />
              <span class="form-error" id="twitterFilter-error"></span>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Tweet duration in seconds</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input type="text" id="twitterTweetDuration" name="twitterTweetDuration" aria-describedby="twitterTweetDuration-error" />
              <span class="form-error" id="twitterTweetDuration-error"></span>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Show Retweets</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input type="checkbox" name="twitterShowRetweets" />
            </div>
          </div>

        </div>
        <div class="tabs-panel bg-weather" id="panel2" data-apptype="weather">
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Location</label>
            </div>
            <div class="small-9 columns weatherLocation-column">
              <input disabled type="text" id="weatherLocation" name="weatherLocation" autocomplete="off" spellcheck="off" data-toggle="location-dropdown" />
              <div class="dropdown-pane bottom" id="location-dropdown" data-dropdown data-close-on-click="true">
              </div>
              <input disabled type="hidden" name="weatherLocationCode" value="">
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Unit</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="radio" name="weatherUnit" value="true" id="c" checked><label for="c">°C</label>
              <input disabled type="radio" name="weatherUnit" value="false" id="f"><label for="f">°F</label>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Font color</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="text" id="weatherFontColor" name="weatherFontColor" aria-describedby="weatherFontColor-error" />
              <span class="form-error" id="weatherFontColor-error"></span>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Background image</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="text" id="weatherBackgroundImage" name="weatherBackgroundImage" aria-describedby="weatherBackgroundImage-error" />
              <span class="form-error" id="weatherBackgroundImage-error"></span>
            </div>
          </div>
        </div>
        <div class="tabs-panel bg-msg" id="panel3" data-apptype="msg">
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Headline</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="text" id="msgHeadline" name="msgHeadline" aria-describedby="msgHeadline-error" />
              <span class="form-error" id="msgHeadline-error"></span>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Text</label>
            </div>
            <div class="medium-9 small-12 columns">
              <textarea disabled id="msgText" name="msgText"></textarea aria-describedby="msgText-error" />
              <span class="form-error" id="msgText-error"></span>
            </div>
          </div>
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">Image</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="text" id="msgImage" name="msgImage" aria-describedby="msgImage-error" />
              <span class="form-error" id="msgImage-error"></span>
            </div>
          </div>
        </div>
        <div class="tabs-panel bg-dvb" id="panel4" data-apptype="dvb">
          <div class="row">
            <div class="medium-3 small-12 columns">
              <label for="middle-label" class="text-left medium-text-right middle">DVB Stop</label>
            </div>
            <div class="medium-9 small-12 columns">
              <input disabled type="text" id="dvbStop" name="dvbStop" aria-describedby="dvbStop-error" />
              <span class="form-error" id="dvbStop-error"></span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <br />
  <div class="row">
    <div class="medium-3 small-12 columns">
      <label for="middle-label" class="text-left medium-text-right middle color-list"><i class="fa fa-list" aria-hidden="true"></i> Add to these Playlists</label>
    </div>
    <div class="medium-9 small-12 columns">
      <select name="playlist" multiple>
        <% for(var i=0; i<lists.length; i++){ %>
          <option value="<%= lists[i].id %>"><%= lists[i].name %></option>
        <% } %>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="medium-offset-3 shrink columns">
      <input type="hidden" name="appType" value="twitter" id="appType" />
      <button type="submit" class="button success"><i class="fa fa-save"></i> save</button>
    </div>
    <div class="columns">
        <a data-open="deleteModal" class="button alert hollow" <% if(!item){ %>style="display:none;"<% } %>><i class="fa fa-trash"></i> delete</a>
    </div>
  </div>

</form>

<hr />
<a href="/admin" class="button alert"><i class="fa fa-times"></i> cancel</a>

<div class="reveal alert callout" id="deleteModal" data-reveal>
  <h2>Delete this App?</h2>
  <p><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> This action cannot be undone!</p>
  <div class="row">
    <div class="columns shrink">
      <a class="button primary hollow" data-close aria-label="Close modal"><i class="fa fa-close" aria-hidden="true"></i> No, keep it</a>
    </div>
    <div class="columns">
      <a href="#" class="button alert" id="deleteButton"><i class="fa fa-trash" aria-hidden="true"></i> Yes, delete app</a>
    </div>
  </div>
  <button class="close-button" data-close aria-label="Close modal" type="button">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

<script type="text/javascript">



/**
 * Onload function for all PlaylistItem forms
 */
  $.PlaylistItem = function(){
    $.changeAppTab();
    $.Geocoder();
    $.bindFormSubmit();
    $.bindDeleteButton();

    <% if(item){ %>
      $.PlaylistItemEdit();
    <% } %>
  };

  $.bindFormSubmit = function(){
    $('form').on('submit', function(e){
      e.preventDefault();
      // disable submit button
      $('form input[type="submit]').prop('disabled', true);
      // remove all error / success messages
      $('.callout[role="alert"]').hide();
      $('label.is-invalid-label').removeClass('is-invalid-label');
      $('.is-invalid-input').removeClass('is-invalid-input');
      $('span.is-visible').removeClass('is-visible');
      $.submitData($(this).serializeObject());
    });
  };

  $.submitData = function(data){
    io.socket.post($('form').attr('action'), data, function(resData, jwres){
      if(jwres.statusCode==200 || jwres.statusCode==201)
        $.handleFormSuccess(resData);
      if(jwres.statusCode==400)
        $.handleFormError(resData);

      $('form input[type="submit]').prop('disabled', false);
    });
  };

  $.bindDeleteButton = function(){
    $('#deleteButton').on('click', function(e){
      e.preventDefault();
      io.socket.delete($('form').attr('action'), function(){
        window.location.href = '/admin';
      });
    });
  };

  $.handleFormSuccess = function(resData){
    console.log(resData);
    // success message
    $('.success.callout[role="alert"]').show();
    // change form action to edit
    $('form').attr('action', $('form').attr('data-action-url') + resData.id);
    // show delete button
    $('a[data-open="deleteModal"]').removeAttr('style');
    // override fields with saved data from successful response
    $.insertFormData(resData);
  };

  $.handleFormError = function(resData){
    $('.alert.callout[role="alert"]').show();
    for(key in resData.invalidAttributes){
      $('label[for="'+key+'"]').addClass('is-invalid-label');
      $('#'+key).addClass('is-invalid-input')
      $('span#'+key+'-error').html(resData.invalidAttributes[key][0].message).addClass('is-visible');
    }
  };

  /**
   * Changes the Tabs between different Apps: important for hidden field
   * @param  {String} apptype [weather,twitter,msg]
   */
  $.changeAppTab = function(apptype) {
    if(!apptype) apptype = $('#playlistitem-tabs li.is-active').attr('data-apptype');
    $('input#appType').attr('value', apptype);
    $('form .tabs-panel').find('input, textarea').prop('disabled', true);
    $('form .tabs-panel[data-apptype="'+apptype+'"]').find('input, textarea').prop('disabled', false);
  };

  /**
   * Event Listener for changing tabs
   */
  $('#playlistitem-tabs').on('change.zf.tabs', function(i, e){
    var apptype = $(e).attr('data-apptype');
    $.changeAppTab(apptype);
  });

  /**
   * Changes the create form to an update form
   */
  $.PlaylistItemEdit = function(){
    io.socket.get('/playlistitem/<%= item %>', function(resData, jwres) {
      $.insertFormData(resData);
    });
  };

  /**
   * inserts playlistitem data into the form (at onload for edit or after submit)
   * @param  {[type]} resData [description]
   * @return {[type]}         [description]
   */
  $.insertFormData = function(resData){
    // open right tab
    $('#playlistitem-tabs').foundation('selectTab', $('.tabs-panel[data-apptype="'+resData.appType+'"]'));

    // insert data into form inputs
    $.each(resData, function(index, value) {
        $('form input[name="'+index+'"]:text').attr('value', value);
        $('form textarea[name="'+index+'"]').html(value);
        $('form input[name="'+index+'"][value="'+value+'"]:radio').prop('checked', true);
        $('form input[name="'+index+'"]:checkbox').prop('checked', value);
        if(typeof(value) === 'object' && value !== null)
          $('form select[name="'+index+'"] option[value="'+value.id+'"]').attr('selected','');
    });
  };

  /**
   * Shows Dropdown of weather locations and binds them on click
   * @param  {Array} data List of location objects with infos about country, country code, etc..
   */
  $.openGeocodeDropdown = function(data){
    var menu = $('<ul class="menu vertical">');
    for(var i=0; i<data.message.length; i++){
      var menuItem = $('<a>')
          .html(data.message[i].city + ', ' + data.message[i].state + ', ' + data.message[i].country)
          .attr('data-weatherLocationCode', data.message[i].city + ',' + data.message[i].countryCode)
          .attr('data-weatherLocation', data.message[i].city)
          .appendTo(menu)
          .bind('click', function(e){
            e.preventDefault();
            $('input[name="weatherLocation"]')
              .attr('value', $(this).attr('data-weatherLocation'))
              .val($(this).attr('data-weatherLocation'));
            $('input[name="weatherLocationCode"]').attr('value', $(this).attr('data-weatherLocationCode'));
            $('#location-dropdown').foundation('close');
          })
          .wrapAll('<li />');
    }
    $('#location-dropdown').html(menu);
    $('#location-dropdown').foundation('open');
  };

  /**
   * Event Listener for the weather location input. Calls the geocoder socket to obtain location data
   */
  $.Geocoder = function(){
    $('input[name="weatherLocation"]').on('input', function(){
      $('input[name="weatherLocationCode"]').attr('value','');
      io.socket.get('/admin/geocode?location='+$(this).val(), function(resData, jwres){
        if(!resData) return;
        $.openGeocodeDropdown(resData);
      });
    });

  };

</script>
